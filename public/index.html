<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a472a">
  <meta name="description" content="CEREBRO - Dream Team Multiagente para PyMES Agr√≠colas">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CEREBRO">
  <title>CEREBRO - Dream Team Multiagente</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    :root {
      --primary: #1a472a;
      --primary-light: #2d5a3d;
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --text: #333333;
      --text-light: #666666;
      --border: #e0e0e0;
      --agent-agroexpert: #4caf50;
      --agent-cfo: #2196f3;
      --agent-legal: #9c27b0;
      --agent-estratega: #ff9800;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-logo { font-size: 28px; }
    .header-title h1 { font-size: 18px; font-weight: 600; }
    .header-title p { font-size: 11px; opacity: 0.85; }

    /* Barra de agentes - m√°s grande */
    .agents-bar {
      background: var(--card-bg);
      padding: 16px;
      display: flex;
      gap: 12px;
      justify-content: center;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .agent-chip {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 16px 24px;
      border-radius: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      border: 3px solid transparent;
      min-width: 100px;
    }
    .agent-chip .agent-icon { font-size: 32px; }
    .agent-chip .agent-name { font-size: 14px; font-weight: 600; }
    .agent-chip .agent-desc { font-size: 10px; opacity: 0.7; }
    .agent-chip.agroexpert { background: rgba(76, 175, 80, 0.12); color: var(--agent-agroexpert); }
    .agent-chip.cfo { background: rgba(33, 150, 243, 0.12); color: var(--agent-cfo); }
    .agent-chip.legal { background: rgba(156, 39, 176, 0.12); color: var(--agent-legal); }
    .agent-chip.estratega { background: rgba(255, 152, 0, 0.12); color: var(--agent-estratega); }
    .agent-chip:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .agent-chip.active {
      border-color: currentColor;
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .agent-chip.active .agent-icon { transform: scale(1.1); }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 16px;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.user {
      align-self: flex-end;
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message.assistant {
      align-self: flex-start;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }
    .message-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }
    .agent-badge {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .agent-badge.agroexpert { background: var(--agent-agroexpert); color: white; }
    .agent-badge.cfo { background: var(--agent-cfo); color: white; }
    .agent-badge.legal { background: var(--agent-legal); color: white; }
    .agent-badge.estratega { background: var(--agent-estratega); color: white; }
    .message-content {
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .message-content strong { font-weight: 600; }
    .typing-cursor {
      display: inline-block;
      width: 8px;
      height: 16px;
      background: var(--primary);
      animation: blink 0.8s infinite;
      vertical-align: text-bottom;
      margin-left: 2px;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    .input-area {
      background: var(--card-bg);
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    .input-wrapper {
      flex: 1;
      display: flex;
      background: var(--bg);
      border-radius: 24px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .input-wrapper:focus-within { border-color: var(--primary); }
    #message-input {
      flex: 1;
      border: none;
      padding: 12px 16px;
      font-size: 16px;
      background: transparent;
      resize: none;
      max-height: 100px;
      font-family: inherit;
    }
    #message-input:focus { outline: none; }
    .send-btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .send-btn:hover { background: var(--primary-light); }
    .send-btn:disabled { background: var(--border); cursor: not-allowed; }
    .send-btn svg { width: 22px; height: 22px; }

    /* Welcome screen personalizado por agente */
    .welcome {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 24px;
    }
    .welcome-icon { font-size: 64px; margin-bottom: 16px; transition: all 0.3s; }
    .welcome h2 { font-size: 24px; margin-bottom: 8px; transition: all 0.3s; }
    .welcome .agent-subtitle {
      font-size: 14px;
      margin-bottom: 24px;
      max-width: 400px;
      line-height: 1.5;
    }
    .example-questions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      max-width: 500px;
    }
    .example-btn {
      background: var(--card-bg);
      border: 2px solid var(--border);
      padding: 14px 18px;
      border-radius: 14px;
      font-size: 14px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .example-btn:hover {
      border-color: var(--primary);
      background: rgba(26,71,42,0.05);
      transform: translateX(4px);
    }
    .example-btn .btn-icon { font-size: 20px; }

    /* Colores din√°micos seg√∫n agente */
    .welcome.estratega h2 { color: var(--agent-estratega); }
    .welcome.estratega .example-btn:hover { border-color: var(--agent-estratega); }
    .welcome.agroexpert h2 { color: var(--agent-agroexpert); }
    .welcome.agroexpert .example-btn:hover { border-color: var(--agent-agroexpert); }
    .welcome.cfo h2 { color: var(--agent-cfo); }
    .welcome.cfo .example-btn:hover { border-color: var(--agent-cfo); }
    .welcome.legal h2 { color: var(--agent-legal); }
    .welcome.legal .example-btn:hover { border-color: var(--agent-legal); }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #1a1a1a;
        --card-bg: #2d2d2d;
        --text: #ffffff;
        --text-light: #aaaaaa;
        --border: #404040;
      }
    }
    @media (max-width: 600px) {
      .agents-bar { padding: 12px 8px; gap: 8px; }
      .agent-chip { padding: 12px 16px; min-width: 80px; }
      .agent-chip .agent-icon { font-size: 24px; }
      .agent-chip .agent-name { font-size: 12px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-logo">üß†</div>
    <div class="header-title">
      <h1>CEREBRO</h1>
      <p>Dream Team Multiagente</p>
    </div>
  </header>

  <div class="agents-bar">
    <div class="agent-chip agroexpert" data-agent="agroexpert">
      <span class="agent-icon">üå±</span>
      <span class="agent-name">Agr√≥nomo</span>
    </div>
    <div class="agent-chip cfo" data-agent="cfo">
      <span class="agent-icon">üí∞</span>
      <span class="agent-name">CFO</span>
    </div>
    <div class="agent-chip legal" data-agent="legal">
      <span class="agent-icon">‚öñÔ∏è</span>
      <span class="agent-name">Legal</span>
    </div>
    <div class="agent-chip estratega active" data-agent="estratega">
      <span class="agent-icon">üìä</span>
      <span class="agent-name">Estratega</span>
    </div>
  </div>

  <div class="chat-container" id="chat-container">
    <div class="welcome estratega" id="welcome-screen">
      <div class="welcome-icon" id="welcome-icon">üìä</div>
      <h2 id="welcome-title">Estratega</h2>
      <p class="agent-subtitle" id="welcome-subtitle">Consultor empresarial con conocimiento de 20+ libros de management y metodolog√≠as aplicadas a agronegocios mexicanos.</p>
      <div class="example-questions" id="example-questions">
        <!-- Se llena din√°micamente -->
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrapper">
      <textarea id="message-input" placeholder="Escribe tu consulta..." rows="1"></textarea>
    </div>
    <button class="send-btn" id="send-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
      </svg>
    </button>
  </div>

  <script>
    // Configuraci√≥n de cada agente
    const AGENT_CONFIG = {
      estratega: {
        icon: 'üìä',
        title: 'Estratega',
        subtitle: 'Consultor empresarial con conocimiento de 20+ libros de management y metodolog√≠as aplicadas a agronegocios mexicanos.',
        questions: [
          { icon: 'üìö', text: '¬øQu√© libros de estrategia conoces?', question: '¬øQu√© libros de estrategia conoces y c√≥mo los aplicas a agronegocios?' },
          { icon: 'üß©', text: '¬øQu√© metodolog√≠as manejas?', question: '¬øQu√© metodolog√≠as y frameworks de gesti√≥n manejas? Dame un cat√°logo completo.' },
          { icon: 'ü¶î', text: 'Hedgehog Concept (Jim Collins)', question: 'Expl√≠came el Hedgehog Concept de Jim Collins aplicado a mi empresa de berries' },
          { icon: '‚öôÔ∏è', text: 'Teor√≠a de Restricciones (TOC)', question: '¬øC√≥mo aplico la Teor√≠a de Restricciones de Goldratt en mi operaci√≥n agr√≠cola?' },
          { icon: 'üìà', text: 'OKRs para agronegocio', question: '¬øC√≥mo implemento OKRs en mi empresa agr√≠cola? Dame ejemplos concretos.' }
        ]
      },
      agroexpert: {
        icon: 'üå±',
        title: 'Agr√≥nomo',
        subtitle: 'Ingeniero agr√≥nomo experto en berries mexicanos con 40 a√±os de experiencia en producci√≥n, plagas, riego y clima.',
        questions: [
          { icon: 'ü´ê', text: 'Rendimiento de ar√°ndano', question: '¬øCu√°l es el rendimiento esperado por hect√°rea de ar√°ndano en Jalisco?' },
          { icon: 'üå°Ô∏è', text: 'Riesgo de heladas', question: '¬øC√≥mo protejo mis cultivos de las heladas? ¬øQu√© medidas preventivas recomiendas?' },
          { icon: 'üíß', text: 'Sistema de riego', question: '¬øQu√© sistema de riego me recomiendas para frambuesa y por qu√©?' },
          { icon: 'üêõ', text: 'Control de plagas', question: '¬øCu√°les son las principales plagas en berries y c√≥mo las controlo?' },
          { icon: 'üß™', text: 'Fertilizaci√≥n', question: '¬øCu√°l es el programa de fertilizaci√≥n recomendado para zarzamora?' }
        ]
      },
      cfo: {
        icon: 'üí∞',
        title: 'CFO',
        subtitle: 'Director financiero especializado en agronegocios. An√°lisis de costos, rentabilidad, flujo de caja y decisiones de inversi√≥n.',
        questions: [
          { icon: 'üìä', text: 'Costo por kilo de berries', question: '¬øCu√°nto me cuesta producir un kilo de ar√°ndano? Desglose completo.' },
          { icon: 'üíµ', text: 'Punto de equilibrio', question: '¬øCu√°l es mi punto de equilibrio en hect√°reas y producci√≥n?' },
          { icon: 'üìà', text: 'ROI de inversi√≥n', question: '¬øCu√°l ser√≠a el ROI si invierto en 10 hect√°reas m√°s de frambuesa?' },
          { icon: 'üí∞', text: 'Flujo de caja', question: '¬øC√≥mo manejo el flujo de caja en temporada baja?' },
          { icon: 'üè¶', text: 'Financiamiento FIRA', question: '¬øQu√© opciones de financiamiento FIRA tengo disponibles?' }
        ]
      },
      legal: {
        icon: '‚öñÔ∏è',
        title: 'Legal Laboral',
        subtitle: 'Abogado especializado en derecho laboral mexicano y sector agr√≠cola. Contratos, actas, finiquitos y cumplimiento LFT.',
        questions: [
          { icon: 'üìã', text: 'Generar acta administrativa', question: 'Necesito hacer un acta administrativa para un trabajador que lleg√≥ en estado de ebriedad' },
          { icon: 'üìù', text: 'Contrato por temporada', question: '¬øC√≥mo hago un contrato por temporada seg√∫n el Art. 39-F?' },
          { icon: '‚ö†Ô∏è', text: 'Faltas injustificadas', question: 'Un empleado tiene 4 faltas injustificadas este mes, ¬øqu√© procede legalmente?' },
          { icon: 'üíº', text: 'Calcular finiquito', question: '¬øC√≥mo calculo el finiquito de un trabajador con 3 a√±os de antig√ºedad?' },
          { icon: 'üîç', text: 'Historial de actas', question: 'Mu√©strame las actas recientes de la empresa' }
        ]
      }
    };

    let selectedAgent = 'estratega';
    let isLoading = false;
    let currentMessageEl = null;

    const chatContainer = document.getElementById('chat-container');
    const welcomeScreen = document.getElementById('welcome-screen');
    const welcomeIcon = document.getElementById('welcome-icon');
    const welcomeTitle = document.getElementById('welcome-title');
    const welcomeSubtitle = document.getElementById('welcome-subtitle');
    const exampleQuestions = document.getElementById('example-questions');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const agentChips = document.querySelectorAll('.agent-chip');

    // Inicializar pantalla de bienvenida
    updateWelcomeScreen('estratega');

    // Selecci√≥n de agente
    agentChips.forEach(chip => {
      chip.addEventListener('click', () => {
        agentChips.forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        selectedAgent = chip.dataset.agent;
        updateWelcomeScreen(selectedAgent);
      });
    });

    function updateWelcomeScreen(agent) {
      const config = AGENT_CONFIG[agent];

      // Actualizar clase para colores
      welcomeScreen.className = `welcome ${agent}`;

      // Actualizar contenido
      welcomeIcon.textContent = config.icon;
      welcomeTitle.textContent = config.title;
      welcomeSubtitle.textContent = config.subtitle;

      // Generar botones de preguntas
      exampleQuestions.innerHTML = config.questions.map(q => `
        <button class="example-btn" data-question="${q.question}">
          <span class="btn-icon">${q.icon}</span>
          <span>${q.text}</span>
        </button>
      `).join('');

      // Agregar event listeners a los nuevos botones
      document.querySelectorAll('.example-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          messageInput.value = btn.dataset.question;
          sendMessage();
        });
      });

      // Mostrar welcome screen si estaba oculto
      welcomeScreen.style.display = 'flex';
    }

    // Auto-resize textarea
    messageInput.addEventListener('input', () => {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
    });

    // Enter para enviar
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    // Enviar mensaje con streaming
    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message || isLoading) return;

      welcomeScreen.style.display = 'none';
      addMessage(message, 'user');
      messageInput.value = '';
      messageInput.style.height = 'auto';

      isLoading = true;
      sendBtn.disabled = true;

      // Crear mensaje del asistente vac√≠o
      currentMessageEl = createAssistantMessage(selectedAgent);

      try {
        const response = await fetch('/api/chat/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, agent: selectedAgent })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const jsonStr = line.slice(6).trim();
                if (jsonStr) {
                  const data = JSON.parse(jsonStr);
                  if (data.type === 'text') {
                    fullText += data.content;
                    updateAssistantMessage(currentMessageEl, fullText, true);
                  } else if (data.type === 'end') {
                    updateAssistantMessage(currentMessageEl, fullText, false);
                  } else if (data.type === 'error') {
                    updateAssistantMessage(currentMessageEl, 'Error: ' + data.message, false);
                  } else if (data.type === 'tool_start' || data.type === 'tool_executing') {
                    const toolName = formatToolName(data.tool);
                    const indicator = data.type === 'tool_start'
                      ? `üîß Preparando: ${toolName}...`
                      : `‚öôÔ∏è Ejecutando: ${toolName}...`;
                    updateAssistantMessage(currentMessageEl, fullText + '\n\n_' + indicator + '_', true);
                  }
                }
              } catch (e) {
                console.error('Parse error:', e, line);
              }
            }
          }
        }

        // Procesar buffer restante
        if (buffer.startsWith('data: ')) {
          try {
            const data = JSON.parse(buffer.slice(6).trim());
            if (data.type === 'text') {
              fullText += data.content;
            }
            updateAssistantMessage(currentMessageEl, fullText, false);
          } catch (e) {}
        }

      } catch (error) {
        console.error('Fetch error:', error);
        updateAssistantMessage(currentMessageEl, 'Error de conexi√≥n: ' + error.message, false);
      } finally {
        isLoading = false;
        sendBtn.disabled = false;
        currentMessageEl = null;
      }
    }

    function addMessage(content, type) {
      const el = document.createElement('div');
      el.className = `message ${type}`;
      el.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
      chatContainer.appendChild(el);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function createAssistantMessage(agent) {
      const el = document.createElement('div');
      el.className = 'message assistant';
      el.innerHTML = `
        <div class="message-header">
          <span class="agent-badge ${agent}">${AGENT_CONFIG[agent].title}</span>
        </div>
        <div class="message-content"><span class="typing-cursor"></span></div>
      `;
      chatContainer.appendChild(el);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return el;
    }

    function updateAssistantMessage(el, text, isStreaming) {
      const content = el.querySelector('.message-content');
      const formatted = formatMarkdown(text);
      content.innerHTML = formatted + (isStreaming ? '<span class="typing-cursor"></span>' : '');
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatMarkdown(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/_(.*?)_/g, '<em>$1</em>')
        .replace(/^### (.*$)/gm, '<strong>$1</strong>')
        .replace(/^## (.*$)/gm, '<strong style="font-size:1.1em">$1</strong>')
        .replace(/^# (.*$)/gm, '<strong style="font-size:1.2em">$1</strong>');
    }

    function formatToolName(toolName) {
      const names = {
        'analizar_incidente': 'Analizando incidente',
        'generar_acta': 'Generando acta',
        'buscar_faltas': 'Buscando en cat√°logo',
        'obtener_pruebas_recomendadas': 'Obteniendo pruebas',
        'listar_actas_recientes': 'Consultando historial',
        'exportar_acta': 'Exportando documento'
      };
      return names[toolName] || toolName;
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
</body>
</html>
